<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FriendChat Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.4.7/peerjs.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2c2f33 0%, #23272a 100%);
            color: #dcddde;
            height: 100vh;
            overflow: hidden;
        }

        .app-container {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 260px;
            background: linear-gradient(180deg, #2f3136 0%, #36393f 100%);
            border-right: 1px solid #40444b;
            display: flex;
            flex-direction: column;
        }

        .server-header {
            padding: 16px;
            border-bottom: 1px solid #40444b;
            font-weight: 600;
            background: rgba(114, 137, 218, 0.1);
            text-align: center;
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .connection-section {
            padding: 16px 8px;
        }

        .section-title {
            font-size: 12px;
            font-weight: 600;
            color: #8e9297;
            text-transform: uppercase;
            margin-bottom: 8px;
            margin-top: 16px;
            letter-spacing: 0.5px;
            padding: 0 8px;
        }

        .section-title:first-child {
            margin-top: 0;
        }

        .input-group {
            margin-bottom: 12px;
            padding: 0 8px;
        }

        .input-group input {
            width: 100%;
            padding: 8px 12px;
            background: #40444b;
            border: 1px solid #72767d;
            border-radius: 4px;
            color: #dcddde;
            font-size: 14px;
            transition: border-color 0.2s ease;
        }

        .input-group input:focus {
            outline: none;
            border-color: #7289da;
        }

        .btn {
            width: 100%;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 8px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #7289da, #677bc4);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(45deg, #677bc4, #5b6bb0);
            transform: translateY(-1px);
        }

        .btn-success {
            background: linear-gradient(45deg, #43b581, #3ca374);
            color: white;
        }

        .btn-success:hover {
            background: linear-gradient(45deg, #3ca374, #359268);
        }

        .btn-danger {
            background: linear-gradient(45deg, #f04747, #d73c3c);
            color: white;
        }

        .btn-danger:hover {
            background: linear-gradient(45deg, #d73c3c, #c23636);
        }

        .btn-secondary {
            background: #4f545c;
            color: #dcddde;
            font-size: 12px;
            padding: 6px 12px;
        }

        .btn-secondary:hover {
            background: #5d6269;
        }

        .room-info {
            background: rgba(114, 137, 218, 0.1);
            border-radius: 4px;
            padding: 12px 8px;
            margin: 8px 0;
            text-align: center;
        }

        .room-name {
            font-weight: bold;
            color: #7289da;
            margin-bottom: 4px;
        }

        .host-indicator {
            font-size: 11px;
            color: #43b581;
            background: rgba(67, 181, 129, 0.1);
            padding: 2px 6px;
            border-radius: 12px;
            display: inline-block;
            margin-top: 4px;
        }

        .soundpad-section {
            background: #2f3136;
            border-top: 1px solid #40444b;
            padding: 12px 8px;
            max-height: 200px;
            overflow-y: auto;
        }

        .soundpad-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 6px;
            margin-bottom: 8px;
        }

        .sound-btn {
            padding: 8px;
            background: #5865f2;
            border: none;
            border-radius: 4px;
            color: white;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }

        .sound-btn:hover {
            background: #4752c4;
            transform: scale(1.05);
        }

        .sound-btn:active {
            transform: scale(0.95);
        }

        .add-sound {
            margin-bottom: 8px;
        }

        .add-sound input {
            font-size: 12px;
            padding: 6px 8px;
            margin-bottom: 4px;
        }

        .music-section {
            background: #292b2f;
            border-top: 1px solid #40444b;
            padding: 12px 8px;
            max-height: 250px;
            display: flex;
            flex-direction: column;
        }

        .music-controls {
            display: flex;
            gap: 4px;
            margin-bottom: 8px;
        }

        .music-search {
            flex: 1;
            padding: 6px 8px;
            background: #40444b;
            border: 1px solid #72767d;
            border-radius: 4px;
            color: #dcddde;
            font-size: 12px;
        }

        .music-search:focus {
            outline: none;
            border-color: #7289da;
        }

        .music-results {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 8px;
        }

        .music-item {
            display: flex;
            align-items: center;
            padding: 6px;
            background: rgba(79, 84, 92, 0.2);
            border-radius: 4px;
            margin-bottom: 4px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .music-item:hover {
            background: rgba(79, 84, 92, 0.4);
        }

        .music-item img {
            width: 40px;
            height: 30px;
            border-radius: 2px;
            margin-right: 8px;
            object-fit: cover;
        }

        .music-info {
            flex: 1;
            min-width: 0;
        }

        .music-title {
            font-size: 11px;
            color: #dcddde;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .music-duration {
            font-size: 10px;
            color: #99aab5;
        }

        .current-music {
            background: rgba(67, 181, 129, 0.1);
            border: 1px solid #43b581;
            border-radius: 4px;
            padding: 8px;
            margin-bottom: 8px;
            text-align: center;
        }

        .current-music.playing {
            background: rgba(67, 181, 129, 0.2);
        }

        .music-player-controls {
            display: flex;
            gap: 4px;
            margin-top: 4px;
        }

        .music-player-controls button {
            flex: 1;
            padding: 4px;
            background: #4f545c;
            border: none;
            border-radius: 4px;
            color: #dcddde;
            cursor: pointer;
            font-size: 10px;
        }

        .music-player-controls button:hover {
            background: #5d6269;
        }

        .music-player-controls button.active {
            background: #43b581;
        }

        .recent-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 6px 8px;
            margin: 2px 0;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 12px;
            background: rgba(79, 84, 92, 0.2);
        }

        .recent-item:hover {
            background: rgba(79, 84, 92, 0.4);
        }

        .recent-info {
            flex: 1;
            min-width: 0;
        }

        .recent-name {
            color: #dcddde;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .recent-role {
            color: #99aab5;
            font-size: 10px;
        }

        .remove-btn {
            background: none;
            border: none;
            color: #f04747;
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 2px;
            font-size: 10px;
        }

        .remove-btn:hover {
            background: rgba(240, 71, 71, 0.2);
        }

        .user-section {
            padding: 8px;
            background: #292b2f;
            border-top: 1px solid #40444b;
        }

        .user-info {
            display: flex;
            align-items: center;
            padding: 8px;
            border-radius: 4px;
            background: rgba(79, 84, 92, 0.32);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(45deg, #7289da, #99aab5);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 8px;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            padding: 16px 20px;
            border-bottom: 1px solid #40444b;
            background: #36393f;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chat-title {
            font-size: 16px;
            font-weight: 600;
            color: #ffffff;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .voice-controls {
            display: flex;
            gap: 8px;
        }

        .voice-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            background: #4f545c;
            color: #dcddde;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }

        .voice-btn:hover {
            background: #5d6269;
        }

        .voice-btn.active {
            background: #43b581;
            color: white;
        }

        .voice-btn.muted {
            background: #f04747;
            color: white;
        }

        .voice-btn.sharing {
            background: #5865f2;
            color: white;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 16px 20px;
            background: #36393f;
        }

        .message {
            margin-bottom: 16px;
            animation: messageSlide 0.3s ease-out;
        }

        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-header {
            display: flex;
            align-items: center;
            margin-bottom: 4px;
        }

        .message-author {
            font-weight: 600;
            color: #ffffff;
            margin-right: 8px;
        }

        .message-time {
            font-size: 12px;
            color: #72767d;
        }

        .message-content {
            color: #dcddde;
            line-height: 1.4;
            word-wrap: break-word;
        }

        .message-input-container {
            padding: 20px;
            background: #40444b;
            border-top: 1px solid #40444b;
        }

        .input-wrapper {
            display: flex;
            align-items: flex-end;
            gap: 8px;
            position: relative;
        }

        .message-input {
            flex: 1;
            padding: 12px 16px;
            background: #484c52;
            border: none;
            border-radius: 8px;
            color: #dcddde;
            font-size: 14px;
            resize: none;
            outline: none;
            transition: background-color 0.2s ease;
            max-height: 100px;
        }

        .message-input:focus {
            background: #40444b;
        }

        .message-input::placeholder {
            color: #72767d;
        }

        .file-upload-btn {
            padding: 12px;
            background: #5865f2;
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 44px;
            height: 44px;
        }

        .file-upload-btn:hover {
            background: #4752c4;
            transform: scale(1.05);
        }

        .file-input {
            display: none;
        }

        .file-preview {
            max-width: 300px;
            max-height: 200px;
            border-radius: 8px;
            margin-top: 8px;
            cursor: pointer;
            transition: opacity 0.2s ease;
        }

        .file-preview:hover {
            opacity: 0.8;
        }

        .file-attachment {
            display: flex;
            align-items: center;
            background: #4f545c;
            padding: 12px;
            border-radius: 8px;
            margin-top: 8px;
            max-width: 300px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .file-attachment:hover {
            background: #5d6269;
        }

        .file-icon {
            width: 32px;
            height: 32px;
            background: #7289da;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-size: 14px;
            font-weight: bold;
            color: white;
        }

        .file-info {
            flex: 1;
            min-width: 0;
        }

        .file-name {
            font-weight: 500;
            color: #dcddde;
            margin-bottom: 2px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .file-size {
            font-size: 12px;
            color: #99aab5;
        }

        .drag-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(88, 101, 242, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
        }

        .drag-overlay.active {
            display: flex;
        }

        .drag-text {
            color: white;
            font-size: 24px;
            font-weight: 600;
            text-align: center;
            padding: 40px;
            border: 3px dashed rgba(255, 255, 255, 0.5);
            border-radius: 12px;
        }

        .upload-progress {
            position: absolute;
            bottom: 100%;
            left: 0;
            right: 0;
            background: #7289da;
            color: white;
            padding: 8px 16px;
            border-radius: 8px 8px 0 0;
            font-size: 12px;
            display: none;
        }

        .upload-progress.active {
            display: block;
        }

        .connection-status {
            padding: 8px 16px;
            text-align: center;
            font-size: 12px;
            background: #2f3136;
            color: #99aab5;
        }

        .status-connected {
            background: #43b581;
            color: white;
        }

        .status-connecting {
            background: #faa61a;
            color: white;
        }

        .status-error {
            background: #f04747;
            color: white;
        }

        .peer-list {
            margin-top: 8px;
        }

        .peer-item {
            display: flex;
            align-items: center;
            padding: 6px 8px;
            border-radius: 4px;
            margin-bottom: 4px;
            background: rgba(79, 84, 92, 0.2);
            transition: background-color 0.2s ease;
            font-size: 12px;
        }

        .peer-item:hover {
            background: rgba(79, 84, 92, 0.4);
        }

        .peer-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #43b581;
            margin-right: 8px;
        }

        .peer-status.voice {
            background: #7289da;
        }

        .peer-status.screen {
            background: #5865f2;
        }

        .peer-status.host {
            background: #faa61a;
        }

        .hidden {
            display: none;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 16px;
            background: #7289da;
            color: white;
            border-radius: 4px;
            animation: slideIn 0.3s ease-out;
            z-index: 1000;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .screen-share-container {
            background: #2f3136;
            border-radius: 8px;
            padding: 8px;
            margin-top: 8px;
            max-width: 400px;
        }

        .screen-share-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px;
            background: #36393f;
            border-radius: 4px;
            margin-bottom: 8px;
        }

        .screen-share-title {
            font-size: 12px;
            font-weight: 600;
            color: #dcddde;
        }

        .screen-share-video {
            width: 100%;
            border-radius: 4px;
            cursor: pointer;
        }

        .flex-row {
            display: flex;
            gap: 4px;
        }

        .flex-row input {
            flex: 1;
        }

        .flex-row .btn {
            margin-bottom: 0;
            white-space: nowrap;
            flex-shrink: 0;
        }

        /* Hidden YouTube player */
        .youtube-player {
            position: absolute;
            top: -9999px;
            left: -9999px;
        }

        .sound-message {
            background: rgba(88, 101, 242, 0.1);
            border-left: 3px solid #5865f2;
            padding: 8px 12px;
            border-radius: 4px;
            margin-top: 4px;
            font-style: italic;
            color: #b9bbbe;
        }

        .music-message {
            background: rgba(67, 181, 129, 0.1);
            border-left: 3px solid #43b581;
            padding: 8px 12px;
            border-radius: 4px;
            margin-top: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .music-message img {
            width: 40px;
            height: 30px;
            border-radius: 4px;
            object-fit: cover;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="sidebar">
            <div class="server-header">
                <h3>üéÆ FriendChat Pro</h3>
            </div>
            
            <div class="sidebar-content">
                <div class="connection-section">
                    <div class="section-title">Your Profile</div>
                    <div class="input-group">
                        <input type="text" id="usernameInput" placeholder="Your nickname" maxlength="20">
                    </div>
                    
                    <div id="roomSection" class="hidden">
                        <div class="room-info">
                            <div class="room-name" id="roomName">Room Name</div>
                            <div class="host-indicator" id="hostIndicator">üëë Host</div>
                        </div>
                        <button class="btn btn-secondary" id="leaveRoomBtn">üö™ Leave Room</button>
                    </div>
                    
                    <div class="section-title">Create Room</div>
                    <div class="input-group">
                        <input type="text" id="newRoomName" placeholder="Room name" maxlength="30">
                    </div>
                    <div class="input-group">
                        <input type="password" id="newRoomPassword" placeholder="Password (optional)" maxlength="50">
                    </div>
                    <button class="btn btn-primary" id="createRoomBtn">üè† Create Room</button>

                    <div class="section-title">Join Room</div>
                    <div class="input-group">
                        <input type="text" id="joinRoomName" placeholder="Room name">
                    </div>
                    <div class="input-group">
                        <input type="password" id="joinRoomPassword" placeholder="Password">
                    </div>
                    <button class="btn btn-success" id="joinRoomBtn">üöÄ Join Room</button>

                    <div class="section-title">Recent Rooms</div>
                    <div id="recentList">
                        <!-- Recent rooms will appear here -->
                    </div>

                    <div class="peer-list" id="peerList">
                        <div class="section-title">Room Members</div>
                    </div>
                </div>

                <div class="soundpad-section">
                    <div class="section-title">üîä Soundpad</div>
                    <div class="soundpad-grid" id="soundpadGrid">
                        <button class="sound-btn" data-sound="applause">üëè Applause</button>
                        <button class="sound-btn" data-sound="laugh">üòÇ Laugh</button>
                        <button class="sound-btn" data-sound="airhorn">üìØ Airhorn</button>
                        <button class="sound-btn" data-sound="oof">üòµ Oof</button>
                    </div>
                    <div class="add-sound">
                        <input type="text" id="soundName" placeholder="Sound name" maxlength="20">
                        <input type="text" id="soundUrl" placeholder="YouTube URL">
                        <button class="btn btn-secondary" id="addSoundBtn">+ Add</button>
                    </div>
                </div>

                <div class="music-section">
                    <div class="section-title">üéµ Music Bot</div>
                    <div class="music-controls">
                        <input type="text" class="music-search" id="musicSearch" placeholder="Search YouTube...">
                        <button class="btn btn-secondary" id="searchMusicBtn">üîç</button>
                    </div>
                    <div class="music-results" id="musicResults">
                        <!-- Search results will appear here -->
                    </div>
                    <div class="current-music hidden" id="currentMusic">
                        <div style="font-size: 11px; color: #99aab5;">Now Playing</div>
                        <div id="currentMusicTitle">No music playing</div>
                        <div class="music-player-controls">
                            <button id="pauseBtn">‚è∏Ô∏è Pause</button>
                            <button id="stopBtn">‚èπÔ∏è Stop</button>
                            <button id="skipBtn">‚è≠Ô∏è Skip</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="user-section">
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">?</div>
                    <div>
                        <div id="currentUsername">Set nickname</div>
                        <div style="font-size: 12px; color: #99aab5;">Online</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="chat-header">
                <div class="chat-title" id="chatTitle">üè† FriendChat Room</div>
                <div class="header-controls">
                    <div class="voice-controls">
                        <button class="voice-btn" id="micBtn">üé§ Unmuted</button>
                        <button class="voice-btn" id="speakerBtn">üîä Enabled</button>
                        <button class="voice-btn" id="voiceCallBtn">üìû Start Voice</button>
                        <button class="voice-btn" id="screenShareBtn">üñ•Ô∏è Share Screen</button>
                    </div>
                </div>
            </div>

            <div class="connection-status" id="connectionStatus">
                Welcome! Set your nickname and create or join a room
            </div>

            <div class="messages-container" id="messagesContainer">
                <div class="message">
                    <div class="message-header">
                        <span class="message-author">FriendChat Pro Bot</span>
                        <span class="message-time">now</span>
                    </div>
                    <div class="message-content">
                        Welcome to FriendChat Pro! üöÄ<br><br>
                        <strong>New Features:</strong><br>
                        ‚Ä¢ üè† Room names & passwords<br>
                        ‚Ä¢ üëë Host migration system<br>
                        ‚Ä¢ üîä Soundpad with custom sounds<br>
                        ‚Ä¢ üéµ YouTube music bot<br>
                        ‚Ä¢ üíæ Auto-reconnect to rooms<br><br>
                        <strong>Quick Start:</strong><br>
                        1. Set your nickname<br>
                        2. Create a room with name/password<br>
                        3. Share room name with friends<br>
                        4. Use soundpad and music bot to have fun!
                    </div>
                </div>
            </div>

            <div class="message-input-container">
                <div class="upload-progress" id="uploadProgress">
                    <span id="uploadText">Uploading file...</span>
                </div>
                <div class="input-wrapper">
                    <button class="file-upload-btn" id="fileUploadBtn" title="Upload file">
                        üìé
                    </button>
                    <input type="file" class="file-input" id="fileInput" multiple accept="*/*">
                    <textarea 
                        class="message-input" 
                        id="messageInput" 
                        placeholder="Type a message or drag and drop files..." 
                        rows="1"
                        disabled
                    ></textarea>
                </div>
            </div>
        </div>

        <div class="drag-overlay" id="dragOverlay">
            <div class="drag-text">
                üìÅ Drop files here to share with friends!
            </div>
        </div>

        <!-- Hidden YouTube player -->
        <div class="youtube-player" id="youtubePlayer"></div>
    </div>

    <script>
        class FriendChatPro {
            constructor() {
                this.peer = null;
                this.connections = new Map();
                this.username = '';
                this.currentRoom = {
                    name: '',
                    password: '',
                    isHost: false
                };
                this.recentRooms = new Map();
                this.isVoiceCallActive = false;
                this.isMuted = false;
                this.isSpeakerEnabled = true;
                this.localStream = null;
                this.screenStream = null;
                this.isScreenSharing = false;
                this.remoteScreens = new Map();
                this.messages = [];
                this.soundPad = new Map();
                this.currentMusic = null;
                this.musicPlayer = null;
                this.isPlaying = false;
                
                this.initializeElements();
                this.attachEventListeners();
                this.loadSavedData();
                this.initializeSoundPad();
                this.initializeYouTubeAPI();
                this.autoReconnect();
            }

            initializeElements() {
                this.elements = {
                    usernameInput: document.getElementById('usernameInput'),
                    newRoomName: document.getElementById('newRoomName'),
                    newRoomPassword: document.getElementById('newRoomPassword'),
                    createRoomBtn: document.getElementById('createRoomBtn'),
                    joinRoomName: document.getElementById('joinRoomName'),
                    joinRoomPassword: document.getElementById('joinRoomPassword'),
                    joinRoomBtn: document.getElementById('joinRoomBtn'),
                    roomSection: document.getElementById('roomSection'),
                    roomName: document.getElementById('roomName'),
                    hostIndicator: document.getElementById('hostIndicator'),
                    leaveRoomBtn: document.getElementById('leaveRoomBtn'),
                    messageInput: document.getElementById('messageInput'),
                    messagesContainer: document.getElementById('messagesContainer'),
                    connectionStatus: document.getElementById('connectionStatus'),
                    currentUsername: document.getElementById('currentUsername'),
                    userAvatar: document.getElementById('userAvatar'),
                    peerList: document.getElementById('peerList'),
                    micBtn: document.getElementById('micBtn'),
                    speakerBtn: document.getElementById('speakerBtn'),
                    voiceCallBtn: document.getElementById('voiceCallBtn'),
                    screenShareBtn: document.getElementById('screenShareBtn'),
                    fileUploadBtn: document.getElementById('fileUploadBtn'),
                    fileInput: document.getElementById('fileInput'),
                    dragOverlay: document.getElementById('dragOverlay'),
                    uploadProgress: document.getElementById('uploadProgress'),
                    uploadText: document.getElementById('uploadText'),
                    chatTitle: document.getElementById('chatTitle'),
                    recentList: document.getElementById('recentList'),
                    soundpadGrid: document.getElementById('soundpadGrid'),
                    soundName: document.getElementById('soundName'),
                    soundUrl: document.getElementById('soundUrl'),
                    addSoundBtn: document.getElementById('addSoundBtn'),
                    musicSearch: document.getElementById('musicSearch'),
                    searchMusicBtn: document.getElementById('searchMusicBtn'),
                    musicResults: document.getElementById('musicResults'),
                    currentMusic: document.getElementById('currentMusic'),
                    currentMusicTitle: document.getElementById('currentMusicTitle'),
                    pauseBtn: document.getElementById('pauseBtn'),
                    stopBtn: document.getElementById('stopBtn'),
                    skipBtn: document.getElementById('skipBtn'),
                    youtubePlayer: document.getElementById('youtubePlayer')
                };
            }

            attachEventListeners() {
                this.elements.createRoomBtn.addEventListener('click', () => this.createRoom());
                this.elements.joinRoomBtn.addEventListener('click', () => this.joinRoom());
                this.elements.leaveRoomBtn.addEventListener('click', () => this.leaveRoom());
                this.elements.messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });
                this.elements.usernameInput.addEventListener('input', () => this.updateUsername());
                this.elements.micBtn.addEventListener('click', () => this.toggleMute());
                this.elements.speakerBtn.addEventListener('click', () => this.toggleSpeaker());
                this.elements.voiceCallBtn.addEventListener('click', () => this.toggleVoiceCall());
                this.elements.screenShareBtn.addEventListener('click', () => this.toggleScreenShare());
                
                // Soundpad events
                this.elements.addSoundBtn.addEventListener('click', () => this.addCustomSound());
                this.elements.soundpadGrid.addEventListener('click', (e) => {
                    if (e.target.classList.contains('sound-btn')) {
                        this.playSound(e.target.dataset.sound);
                    }
                });
                
                // Music bot events
                this.elements.searchMusicBtn.addEventListener('click', () => this.searchMusic());
                this.elements.musicSearch.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.searchMusic();
                    }
                });
                this.elements.pauseBtn.addEventListener('click', () => this.toggleMusicPause());
                this.elements.stopBtn.addEventListener('click', () => this.stopMusic());
                this.elements.skipBtn.addEventListener('click', () => this.stopMusic());
                
                // File upload events
                this.elements.fileUploadBtn.addEventListener('click', () => this.elements.fileInput.click());
                this.elements.fileInput.addEventListener('change', (e) => this.handleFileSelect(e));
                
                // Drag and drop events
                document.addEventListener('dragover', (e) => this.handleDragOver(e));
                document.addEventListener('dragleave', (e) => this.handleDragLeave(e));
                document.addEventListener('drop', (e) => this.handleDrop(e));
                
                // Auto-resize textarea
                this.elements.messageInput.addEventListener('input', () => this.autoResizeTextarea());
                
                // Enter key support for room creation/joining
                this.elements.newRoomName.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.createRoom();
                });
                this.elements.newRoomPassword.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.createRoom();
                });
                this.elements.joinRoomName.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.joinRoom();
                });
                this.elements.joinRoomPassword.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.joinRoom();
                });
            }

            loadSavedData() {
                try {
                    const savedUsername = localStorage.getItem('friendchat_username');
                    const savedRoom = localStorage.getItem('friendchat_current_room');
                    const savedRecentRooms = localStorage.getItem('friendchat_recent_rooms');
                    const savedSounds = localStorage.getItem('friendchat_custom_sounds');
                    
                    if (savedUsername) {
                        this.elements.usernameInput.value = savedUsername;
                        this.updateUsername();
                    }
                    
                    if (savedRoom) {
                        this.currentRoom = JSON.parse(savedRoom);
                    }
                    
                    if (savedRecentRooms) {
                        const recent = JSON.parse(savedRecentRooms);
                        recent.forEach(room => {
                            this.recentRooms.set(room.name, room);
                        });
                        this.updateRecentList();
                    }
                    
                    if (savedSounds) {
                        const sounds = JSON.parse(savedSounds);
                        sounds.forEach(sound => {
                            this.soundPad.set(sound.name, sound.url);
                        });
                        this.updateSoundPad();
                    }
                } catch (error) {
                    console.log('No saved data found or error loading:', error);
                }
            }

            saveData() {
                try {
                    localStorage.setItem('friendchat_username', this.username);
                    if (this.currentRoom.name) {
                        localStorage.setItem('friendchat_current_room', JSON.stringify(this.currentRoom));
                    }
                    localStorage.setItem('friendchat_recent_rooms', JSON.stringify(Array.from(this.recentRooms.values())));
                    localStorage.setItem('friendchat_custom_sounds', JSON.stringify(Array.from(this.soundPad.entries()).map(([name, url]) => ({name, url}))));
                } catch (error) {
                    console.log('Error saving data:', error);
                }
            }

            updateUsername() {
                this.username = this.elements.usernameInput.value.trim() || 'Anonymous';
                this.elements.currentUsername.textContent = this.username;
                this.elements.userAvatar.textContent = this.username.charAt(0).toUpperCase();
                this.saveData();
            }

            async autoReconnect() {
                if (this.currentRoom.name && this.username) {
                    setTimeout(() => {
                        this.connectToRoom(this.currentRoom.name, this.currentRoom.password);
                    }, 1000);
                }
            }

            generateRoomId(roomName, password) {
                // Create a deterministic ID from room name and password
                const combined = roomName.toLowerCase() + (password || '');
                let hash = 0;
                for (let i = 0; i < combined.length; i++) {
                    const char = combined.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash; // Convert to 32-bit integer
                }
                return 'room_' + Math.abs(hash).toString(36);
            }

            async createRoom() {
                const roomName = this.elements.newRoomName.value.trim();
                if (!roomName) {
                    this.showNotification('Please enter a room name!');
                    return;
                }

                if (!this.username) {
                    this.showNotification('Please set a nickname first!');
                    return;
                }

                const password = this.elements.newRoomPassword.value;
                await this.connectToRoom(roomName, password, true);
            }

            async joinRoom() {
                const roomName = this.elements.joinRoomName.value.trim();
                if (!roomName) {
                    this.showNotification('Please enter a room name!');
                    return;
                }

                if (!this.username) {
                    this.showNotification('Please set a nickname first!');
                    return;
                }

                const password = this.elements.joinRoomPassword.value;
                await this.connectToRoom(roomName, password, false);
            }

            async connectToRoom(roomName, password, isCreating = false) {
                this.updateConnectionStatus('Connecting to room...', 'connecting');

                const roomId = this.generateRoomId(roomName, password);

                try {
                    if (!this.peer || this.peer.destroyed) {
                        this.peer = new Peer(isCreating ? roomId : undefined);
                        
                        await new Promise((resolve, reject) => {
                            this.peer.on('open', resolve);
                            this.peer.on('error', reject);
                            setTimeout(() => reject(new Error('Connection timeout')), 10000);
                        });

                        this.peer.on('connection', (conn) => {
                            this.handleIncomingConnection(conn);
                        });

                        this.peer.on('call', (call) => {
                            this.handleIncomingCall(call);
                        });
                    }

                    if (isCreating || this.peer.id === roomId) {
                        // We are the host (created the room or room doesn't exist)
                        this.becomeHost(roomName, password);
                    } else {
                        // Try to join existing room
                        const conn = this.peer.connect(roomId, {
                            metadata: {
                                username: this.username,
                                password: password
                            }
                        });
                        
                        this.handleOutgoingConnection(conn, roomName, password);
                    }
                    
                } catch (error) {
                    // If connection fails, become host
                    console.log('Could not connect, becoming host:', error);
                    this.becomeHost(roomName, password);
                }
            }

            becomeHost(roomName, password) {
                this.currentRoom = {
                    name: roomName,
                    password: password,
                    isHost: true
                };

                this.elements.roomName.textContent = roomName;
                this.elements.hostIndicator.textContent = 'üëë Host';
                this.elements.hostIndicator.style.display = 'inline-block';
                this.elements.roomSection.classList.remove('hidden');
                this.elements.messageInput.disabled = false;
                this.elements.chatTitle.textContent = `üè† ${roomName}`;
                
                this.clearInputs();
                this.addToRecentRooms(roomName, password, 'Host');
                this.updateConnectionStatus('Room created! Waiting for members...', 'connected');
                this.addMessage('System', `You are now hosting room "${roomName}"`);
                this.saveData();
                this.showNotification(`Hosting room "${roomName}"`);
            }

            handleIncomingConnection(conn) {
                conn.on('open', () => {
                    // Verify password if room has one
                    const roomPassword = this.currentRoom.password;
                    const userPassword = conn.metadata?.password || '';
                    
                    if (roomPassword && roomPassword !== userPassword) {
                        conn.close();
                        return;
                    }

                    this.connections.set(conn.peer, conn);
                    
                    const username = conn.metadata?.username || 'Friend';
                    this.updateConnectionStatus(`${this.connections.size + 1} member(s) in room`, 'connected');
                    this.addMessage('System', `${username} joined the room!`);
                    this.updatePeerList();
                    
                    // Send room info and recent messages
                    conn.send({
                        type: 'room_info',
                        roomName: this.currentRoom.name,
                        isHost: this.currentRoom.isHost,
                        username: this.username,
                        messages: this.messages.slice(-10),
                        currentMusic: this.currentMusic
                    });
                });

                conn.on('data', (data) => {
                    this.handleMessage(data, conn);
                });

                conn.on('close', () => {
                    this.connections.delete(conn.peer);
                    this.updateConnectionStatus(`${this.connections.size + 1} member(s) in room`, this.connections.size > 0 ? 'connected' : '');
                    this.updatePeerList();
                    
                    // If we're the only one left and not host, become host
                    if (this.connections.size === 0 && !this.currentRoom.isHost) {
                        this.migrateToHost();
                    }
                });
            }

            handleOutgoingConnection(conn, roomName, password) {
                conn.on('open', () => {
                    this.connections.set(conn.peer, conn);
                    this.currentRoom = {
                        name: roomName,
                        password: password,
                        isHost: false
                    };
                    
                    this.elements.roomName.textContent = roomName;
                    this.elements.hostIndicator.textContent = 'Member';
                    this.elements.hostIndicator.style.display = 'inline-block';
                    this.elements.roomSection.classList.remove('hidden');
                    this.elements.messageInput.disabled = false;
                    this.elements.chatTitle.textContent = `üè† ${roomName}`;
                    
                    this.clearInputs();
                    this.addToRecentRooms(roomName, password, 'Member');
                    this.updateConnectionStatus(`Joined room! ${this.connections.size + 1} member(s)`, 'connected');
                    this.addMessage('System', `Joined room "${roomName}"`);
                    this.updatePeerList();
                    this.saveData();
                    
                    // Send initial info
                    conn.send({
                        type: 'user_info',
                        username: this.username
                    });
                });

                conn.on('data', (data) => {
                    this.handleMessage(data, conn);
                });

                conn.on('close', () => {
                    this.connections.delete(conn.peer);
                    this.updateConnectionStatus(`${this.connections.size + 1} member(s) in room`, this.connections.size > 0 ? 'connected' : '');
                    this.updatePeerList();
                    
                    // If host disconnected and we have other connections, become host
                    if (this.connections.size > 0) {
                        this.migrateToHost();
                    }
                });

                conn.on('error', (err) => {
                    console.error('Connection error:', err);
                    // If failed to join, try to become host
                    this.becomeHost(roomName, password);
                });
            }

            migrateToHost() {
                if (!this.currentRoom.isHost) {
                    this.currentRoom.isHost = true;
                    this.elements.hostIndicator.textContent = 'üëë Host';
                    this.addMessage('System', 'You are now the host!');
                    this.showNotification('You are now the host!');
                    this.updatePeerList();
                    
                    // Notify other members
                    this.connections.forEach(conn => {
                        conn.send({
                            type: 'host_migration',
                            newHost: this.username
                        });
                    });
                }
            }

            clearInputs() {
                this.elements.newRoomName.value = '';
                this.elements.newRoomPassword.value = '';
                this.elements.joinRoomName.value = '';
                this.elements.joinRoomPassword.value = '';
            }

            addToRecentRooms(roomName, password, role) {
                this.recentRooms.set(roomName, {
                    name: roomName,
                    password: password,
                    role: role,
                    lastConnected: Date.now()
                });
                this.updateRecentList();
                this.saveData();
            }

            updateRecentList() {
                this.elements.recentList.innerHTML = '';
                
                const recent = Array.from(this.recentRooms.values())
                    .sort((a, b) => b.lastConnected - a.lastConnected)
                    .slice(0, 5);

                recent.forEach(room => {
                    const recentItem = document.createElement('div');
                    recentItem.className = 'recent-item';
                    recentItem.innerHTML = `
                        <div class="recent-info">
                            <div class="recent-name">${room.name}</div>
                            <div class="recent-role">${room.role}</div>
                        </div>
                        <button class="remove-btn" onclick="window.friendChat.removeRecentRoom('${room.name}')">√ó</button>
                    `;
                    recentItem.addEventListener('click', (e) => {
                        if (e.target.classList.contains('remove-btn')) return;
                        this.connectToRoom(room.name, room.password);
                    });
                    this.elements.recentList.appendChild(recentItem);
                });
            }

            removeRecentRoom(roomName) {
                this.recentRooms.delete(roomName);
                this.updateRecentList();
                this.saveData();
            }

            leaveRoom() {
                if (this.peer) {
                    this.peer.destroy();
                }
                
                this.connections.clear();
                this.currentRoom = { name: '', password: '', isHost: false };
                this.elements.roomSection.classList.add('hidden');
                this.elements.messageInput.disabled = true;
                this.elements.chatTitle.textContent = 'üè† FriendChat Room';
                this.messages = [];
                this.clearMessages();
                this.stopMusic();
                
                this.updateConnectionStatus('Left room. Create or join a new one.', '');
                this.updatePeerList();
                
                localStorage.removeItem('friendchat_current_room');
                this.showNotification('Left room');
            }

            handleMessage(data, conn) {
                if (data.type === 'message') {
                    this.addMessage(data.username, data.content);
                } else if (data.type === 'file') {
                    this.addFileMessage(data.username, data.fileData);
                } else if (data.type === 'sound') {
                    this.receiveSoundPlay(data.soundName, data.username);
                } else if (data.type === 'music') {
                    this.receiveMusicControl(data);
                } else if (data.type === 'screen-share') {
                    this.handleRemoteScreenShare(data, conn);
                } else if (data.type === 'room_info') {
                    conn.metadata = { username: data.username };
                    this.updatePeerList();
                    
                    if (data.messages && this.messages.length === 0) {
                        data.messages.forEach(msg => {
                            if (msg.type === 'file') {
                                this.addFileMessage(msg.author, msg.fileData, false);
                            } else {
                                this.addMessage(msg.author, msg.content, false);
                            }
                        });
                    }
                    
                    if (data.currentMusic) {
                        this.receiveMusic(data.currentMusic);
                    }
                } else if (data.type === 'user_info') {
                    conn.metadata = { username: data.username };
                    this.updatePeerList();
                } else if (data.type === 'host_migration') {
                    this.addMessage('System', `${data.newHost} is now the host!`);
                }
            }

            // Soundpad functionality
            initializeSoundPad() {
                const defaultSounds = {
                    'applause': 'https://www.soundjay.com/misc/sounds/bell-ringing-05.wav',
                    'laugh': 'https://www.soundjay.com/misc/sounds/bell-ringing-05.wav',
                    'airhorn': 'https://www.soundjay.com/misc/sounds/bell-ringing-05.wav',
                    'oof': 'https://www.soundjay.com/misc/sounds/bell-ringing-05.wav'
                };
                
                // For demo purposes, we'll use a simple beep sound
                Object.keys(defaultSounds).forEach(sound => {
                    if (!this.soundPad.has(sound)) {
                        this.soundPad.set(sound, 'beep');
                    }
                });
            }

            addCustomSound() {
                const name = this.elements.soundName.value.trim();
                const url = this.elements.soundUrl.value.trim();
                
                if (!name || !url) {
                    this.showNotification('Please enter both sound name and URL!');
                    return;
                }
                
                if (!url.includes('youtube.com') && !url.includes('youtu.be')) {
                    this.showNotification('Please use a YouTube URL!');
                    return;
                }
                
                this.soundPad.set(name, url);
                this.updateSoundPad();
                this.elements.soundName.value = '';
                this.elements.soundUrl.value = '';
                this.saveData();
                this.showNotification(`Sound "${name}" added!`);
            }

            updateSoundPad() {
                // Clear existing custom sounds (keep default ones)
                const defaultSounds = ['applause', 'laugh', 'airhorn', 'oof'];
                const existingButtons = this.elements.soundpadGrid.querySelectorAll('.sound-btn');
                existingButtons.forEach(btn => {
                    if (!defaultSounds.includes(btn.dataset.sound)) {
                        btn.remove();
                    }
                });

                // Add custom sounds
                this.soundPad.forEach((url, name) => {
                    if (!defaultSounds.includes(name)) {
                        const button = document.createElement('button');
                        button.className = 'sound-btn';
                        button.dataset.sound = name;
                        button.textContent = `üîä ${name}`;
                        this.elements.soundpadGrid.appendChild(button);
                    }
                });
            }

            playSound(soundName) {
                if (this.connections.size === 0) {
                    this.showNotification('No one connected to hear the sound!');
                    return;
                }

                // Play locally
                this.playSoundLocally(soundName);
                
                // Send to all connected peers
                this.connections.forEach(conn => {
                    conn.send({
                        type: 'sound',
                        soundName: soundName,
                        username: this.username
                    });
                });

                // Add sound message to chat
                this.addSoundMessage(this.username, soundName);
            }

            playSoundLocally(soundName) {
                // Create a simple beep sound for now
                // In a real implementation, you'd load the actual sound file
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            }

            receiveSoundPlay(soundName, username) {
                this.playSoundLocally(soundName);
                this.addSoundMessage(username, soundName);
            }

            addSoundMessage(username, soundName) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message';
                
                const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                messageDiv.innerHTML = `
                    <div class="message-header">
                        <span class="message-author">${username}</span>
                        <span class="message-time">${time}</span>
                    </div>
                    <div class="message-content">
                        <div class="sound-message">üîä Played sound: ${soundName}</div>
                    </div>
                `;

                this.elements.messagesContainer.appendChild(messageDiv);
                this.elements.messagesContainer.scrollTop = this.elements.messagesContainer.scrollHeight;
            }

            // YouTube Music Bot functionality
            initializeYouTubeAPI() {
                // For demo purposes, we'll simulate YouTube search
                // In a real implementation, you'd use the YouTube Data API
            }

            async searchMusic() {
                const query = this.elements.musicSearch.value.trim();
                if (!query) {
                    this.showNotification('Please enter a search term!');
                    return;
                }

                // Simulate YouTube search results
                const mockResults = [
                    {
                        id: 'dQw4w9WgXcQ',
                        title: `${query} - Music Video`,
                        thumbnail: 'https://img.youtube.com/vi/dQw4w9WgXcQ/mqdefault.jpg',
                        duration: '3:32'
                    },
                    {
                        id: 'rickroll2',
                        title: `${query} - Remix`,
                        thumbnail: 'https://img.youtube.com/vi/dQw4w9WgXcQ/mqdefault.jpg',
                        duration: '4:15'
                    },
                    {
                        id: 'rickroll3',
                        title: `${query} - Live Version`,
                        thumbnail: 'https://img.youtube.com/vi/dQw4w9WgXcQ/mqdefault.jpg',
                        duration: '3:45'
                    }
                ];

                this.displayMusicResults(mockResults);
            }

            displayMusicResults(results) {
                this.elements.musicResults.innerHTML = '';
                
                results.forEach(result => {
                    const resultItem = document.createElement('div');
                    resultItem.className = 'music-item';
                    resultItem.innerHTML = `
                        <img src="${result.thumbnail}" alt="Thumbnail">
                        <div class="music-info">
                            <div class="music-title">${result.title}</div>
                            <div class="music-duration">${result.duration}</div>
                        </div>
                    `;
                    resultItem.addEventListener('click', () => {
                        this.playMusic(result);
                    });
                    this.elements.musicResults.appendChild(resultItem);
                });
            }

            playMusic(musicData) {
                if (this.connections.size === 0) {
                    this.showNotification('No one connected to hear the music!');
                    return;
                }

                this.currentMusic = musicData;
                this.isPlaying = true;
                
                // Update UI
                this.elements.currentMusic.classList.remove('hidden');
                this.elements.currentMusic.classList.add('playing');
                this.elements.currentMusicTitle.textContent = musicData.title;
                this.elements.pauseBtn.textContent = '‚è∏Ô∏è Pause';
                this.elements.pauseBtn.classList.add('active');
                
                // Send to all connected peers
                this.connections.forEach(conn => {
                    conn.send({
                        type: 'music',
                        action: 'play',
                        musicData: musicData,
                        username: this.username
                    });
                });

                // Add music message to chat
                this.addMusicMessage(this.username, musicData, 'started playing');
                this.showNotification(`Now playing: ${musicData.title}`);
            }

            receiveMusic(musicData) {
                this.currentMusic = musicData;
                this.elements.currentMusic.classList.remove('hidden');
                this.elements.currentMusicTitle.textContent = musicData.title;
            }

            receiveMusicControl(data) {
                if (data.action === 'play') {
                    this.receiveMusic(data.musicData);
                    this.addMusicMessage(data.username, data.musicData, 'started playing');
                } else if (data.action === 'pause') {
                    this.isPlaying = false;
                    this.elements.currentMusic.classList.remove('playing');
                    this.addMusicMessage(data.username, this.currentMusic, 'paused');
                } else if (data.action === 'resume') {
                    this.isPlaying = true;
                    this.elements.currentMusic.classList.add('playing');
                    this.addMusicMessage(data.username, this.currentMusic, 'resumed');
                } else if (data.action === 'stop') {
                    this.stopMusicLocally();
                    this.addMusicMessage(data.username, this.currentMusic, 'stopped');
                }
            }

            toggleMusicPause() {
                if (!this.currentMusic) return;

                if (this.isPlaying) {
                    this.isPlaying = false;
                    this.elements.currentMusic.classList.remove('playing');
                    this.elements.pauseBtn.textContent = '‚ñ∂Ô∏è Resume';
                    this.elements.pauseBtn.classList.remove('active');
                    
                    this.connections.forEach(conn => {
                        conn.send({
                            type: 'music',
                            action: 'pause',
                            username: this.username
                        });
                    });
                    
                    this.addMusicMessage(this.username, this.currentMusic, 'paused');
                } else {
                    this.isPlaying = true;
                    this.elements.currentMusic.classList.add('playing');
                    this.elements.pauseBtn.textContent = '‚è∏Ô∏è Pause';
                    this.elements.pauseBtn.classList.add('active');
                    
                    this.connections.forEach(conn => {
                        conn.send({
                            type: 'music',
                            action: 'resume',
                            username: this.username
                        });
                    });
                    
                    this.addMusicMessage(this.username, this.currentMusic, 'resumed');
                }
            }

            stopMusic() {
                if (!this.currentMusic) return;

                this.connections.forEach(conn => {
                    conn.send({
                        type: 'music',
                        action: 'stop',
                        username: this.username
                    });
                });

                this.addMusicMessage(this.username, this.currentMusic, 'stopped');
                this.stopMusicLocally();
            }

            stopMusicLocally() {
                this.currentMusic = null;
                this.isPlaying = false;
                this.elements.currentMusic.classList.add('hidden');
                this.elements.currentMusic.classList.remove('playing');
                this.elements.pauseBtn.textContent = '‚è∏Ô∏è Pause';
                this.elements.pauseBtn.classList.remove('active');
            }

            addMusicMessage(username, musicData, action) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message';
                
                const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                messageDiv.innerHTML = `
                    <div class="message-header">
                        <span class="message-author">${username}</span>
                        <span class="message-time">${time}</span>
                    </div>
                    <div class="message-content">
                        <div class="music-message">
                            <img src="${musicData.thumbnail}" alt="Thumbnail">
                            <div>
                                <div>üéµ ${action}: ${musicData.title}</div>
                                <div style="font-size: 10px; color: #99aab5;">${musicData.duration}</div>
                            </div>
                        </div>
                    </div>
                `;

                this.elements.messagesContainer.appendChild(messageDiv);
                this.elements.messagesContainer.scrollTop = this.elements.messagesContainer.scrollHeight;
            }

            sendMessage() {
                const content = this.elements.messageInput.value.trim();
                if (!content || this.connections.size === 0) return;

                const message = {
                    type: 'message',
                    username: this.username,
                    content: content,
                    timestamp: Date.now()
                };

                // Send to all connected peers
                this.connections.forEach(conn => {
                    if (conn.open) {
                        conn.send(message);
                    }
                });

                this.addMessage(this.username, content);
                this.elements.messageInput.value = '';
            }

            addMessage(author, content, saveToHistory = true) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message';
                
                const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                messageDiv.innerHTML = `
                    <div class="message-header">
                        <span class="message-author">${author}</span>
                        <span class="message-time">${time}</span>
                    </div>
                    <div class="message-content">${content}</div>
                `;

                this.elements.messagesContainer.appendChild(messageDiv);
                this.elements.messagesContainer.scrollTop = this.elements.messagesContainer.scrollHeight;

                if (saveToHistory && author !== 'System') {
                    this.messages.push({
                        type: 'message',
                        author: author,
                        content: content,
                        timestamp: Date.now()
                    });
                    
                    if (this.messages.length > 50) {
                        this.messages = this.messages.slice(-50);
                    }
                }
            }

            clearMessages() {
                this.elements.messagesContainer.innerHTML = '';
            }

            updateConnectionStatus(message, status = '') {
                this.elements.connectionStatus.textContent = message;
                this.elements.connectionStatus.className = `connection-status ${status ? 'status-' + status : ''}`;
            }

            updatePeerList() {
                const listContainer = this.elements.peerList;
                const title = listContainer.querySelector('.section-title');
                listContainer.innerHTML = '';
                listContainer.appendChild(title);

                // Add self
                const selfDiv = document.createElement('div');
                selfDiv.className = 'peer-item';
                selfDiv.innerHTML = `
                    <div class="peer-status ${this.currentRoom.isHost ? 'host' : ''}"></div>
                    <span>${this.username} (You) ${this.currentRoom.isHost ? 'üëë' : ''}</span>
                `;
                listContainer.appendChild(selfDiv);

                // Add others
                this.connections.forEach((conn, peerId) => {
                    const peerDiv = document.createElement('div');
                    peerDiv.className = 'peer-item';
                    const username = conn.metadata?.username || 'Friend';
                    
                    let statusClass = '';
                    if (this.isVoiceCallActive) statusClass = 'voice';
                    if (this.remoteScreens.has(peerId)) statusClass = 'screen';
                    
                    peerDiv.innerHTML = `
                        <div class="peer-status ${statusClass}"></div>
                        <span>${username}</span>
                    `;
                    listContainer.appendChild(peerDiv);
                });
            }

            // Voice and Screen Sharing Methods (same as before but simplified for space)
            async toggleVoiceCall() {
                if (!this.isVoiceCallActive) {
                    await this.startVoiceCall();
                } else {
                    this.endVoiceCall();
                }
            }

            async startVoiceCall() {
                if (this.connections.size === 0) {
                    this.showNotification('No friends connected for voice call!');
                    return;
                }

                try {
                    this.localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    this.isVoiceCallActive = true;
                    this.elements.voiceCallBtn.textContent = 'üìû End Voice';
                    this.elements.voiceCallBtn.classList.add('active');
                    
                    this.connections.forEach((conn, peerId) => {
                        const call = this.peer.call(peerId, this.localStream);
                        this.handleOutgoingCall(call);
                    });

                    this.updatePeerList();
                    this.showNotification('Voice call started!');
                } catch (error) {
                    console.error('Error starting voice call:', error);
                    this.showNotification('Could not access microphone');
                }
            }

            endVoiceCall() {
                if (this.localStream) {
                    this.localStream.getTracks().forEach(track => track.stop());
                    this.localStream = null;
                }
                
                this.isVoiceCallActive = false;
                this.elements.voiceCallBtn.textContent = 'üìû Start Voice';
                this.elements.voiceCallBtn.classList.remove('active');
                this.updatePeerList();
                this.showNotification('Voice call ended');
            }

            async toggleScreenShare() {
                if (!this.isScreenSharing) {
                    await this.startScreenShare();
                } else {
                    this.endScreenShare();
                }
            }

            async startScreenShare() {
                if (this.connections.size === 0) {
                    this.showNotification('No friends connected for screen sharing!');
                    return;
                }

                try {
                    this.screenStream = await navigator.mediaDevices.getDisplayMedia({ 
                        video: true, 
                        audio: true 
                    });
                    
                    this.isScreenSharing = true;
                    this.elements.screenShareBtn.textContent = 'üñ•Ô∏è Stop Sharing';
                    this.elements.screenShareBtn.classList.add('sharing');
                    
                    this.screenStream.getVideoTracks()[0].addEventListener('ended', () => {
                        this.endScreenShare();
                    });

                    this.connections.forEach((conn, peerId) => {
                        const call = this.peer.call(peerId, this.screenStream);
                        this.handleOutgoingCall(call);
                        
                        conn.send({
                            type: 'screen-share',
                            username: this.username,
                            isSharing: true
                        });
                    });

                    this.addMessage('System', `${this.username} started screen sharing`);
                    this.showNotification('Screen sharing started!');
                } catch (error) {
                    console.error('Error starting screen share:', error);
                    this.showNotification('Could not start screen sharing');
                }
            }

            endScreenShare() {
                if (this.screenStream) {
                    this.screenStream.getTracks().forEach(track => track.stop());
                    this.screenStream = null;
                }
                
                this.isScreenSharing = false;
                this.elements.screenShareBtn.textContent = 'üñ•Ô∏è Share Screen';
                this.elements.screenShareBtn.classList.remove('sharing');
                
                this.connections.forEach((conn, peerId) => {
                    conn.send({
                        type: 'screen-share',
                        username: this.username,
                        isSharing: false
                    });
                });

                this.addMessage('System', `${this.username} stopped screen sharing`);
                this.showNotification('Screen sharing ended');
            }

            handleIncomingCall(call) {
                call.answer();
                call.on('stream', (remoteStream) => {
                    this.playRemoteStream(remoteStream, call.peer);
                });
            }

            handleOutgoingCall(call) {
                call.on('stream', (remoteStream) => {
                    this.playRemoteStream(remoteStream, call.peer);
                });
            }

            playRemoteStream(stream, peerId) {
                const tracks = stream.getTracks();
                const isScreenShare = tracks.length > 0 && tracks[0].kind === 'video';
                
                if (isScreenShare) {
                    this.displayRemoteScreen(stream, peerId);
                } else {
                    const audio = document.createElement('audio');
                    audio.srcObject = stream;
                    audio.autoplay = true;
                    audio.volume = this.isSpeakerEnabled ? 1 : 0;
                    document.body.appendChild(audio);
                }
            }

            displayRemoteScreen(stream, peerId) {
                this.remoteScreens.set(peerId, stream);
                
                const screenContainer = document.createElement('div');
                screenContainer.className = 'screen-share-container';
                screenContainer.id = `screen-${peerId}`;
                
                const peerName = this.connections.get(peerId)?.metadata?.username || 'Friend';
                
                screenContainer.innerHTML = `
                    <div class="screen-share-header">
                        <span class="screen-share-title">üñ•Ô∏è ${peerName}'s Screen</span>
                        <button class="btn btn-secondary" onclick="this.parentElement.parentElement.remove()">√ó</button>
                    </div>
                    <video class="screen-share-video" autoplay muted></video>
                `;
                
                const video = screenContainer.querySelector('video');
                video.srcObject = stream;
                video.addEventListener('click', () => {
                    if (video.requestFullscreen) {
                        video.requestFullscreen();
                    }
                });
                
                this.elements.messagesContainer.appendChild(screenContainer);
                this.elements.messagesContainer.scrollTop = this.elements.messagesContainer.scrollHeight;
                this.updatePeerList();
            }

            handleRemoteScreenShare(data, conn) {
                const peerName = conn.metadata?.username || 'Friend';
                if (data.isSharing) {
                    this.addMessage('System', `${peerName} started screen sharing`);
                } else {
                    this.addMessage('System', `${peerName} stopped screen sharing`);
                    const screenElement = document.getElementById(`screen-${conn.peer}`);
                    if (screenElement) {
                        screenElement.remove();
                    }
                    this.remoteScreens.delete(conn.peer);
                    this.updatePeerList();
                }
            }

            toggleMute() {
                this.isMuted = !this.isMuted;
                if (this.localStream) {
                    this.localStream.getAudioTracks().forEach(track => {
                        track.enabled = !this.isMuted;
                    });
                }
                this.elements.micBtn.textContent = this.isMuted ? 'üé§ Muted' : 'üé§ Unmuted';
                this.elements.micBtn.classList.toggle('muted', this.isMuted);
            }

            toggleSpeaker() {
                this.isSpeakerEnabled = !this.isSpeakerEnabled;
                const audioElements = document.querySelectorAll('audio');
                audioElements.forEach(audio => {
                    audio.volume = this.isSpeakerEnabled ? 1 : 0;
                });
                this.elements.speakerBtn.textContent = this.isSpeakerEnabled ? 'üîä Enabled' : 'üîá Disabled';
            }

            // File handling methods (simplified for space)
            handleFileSelect(event) {
                const files = Array.from(event.target.files);
                this.processFiles(files);
                event.target.value = '';
            }

            handleDragOver(event) {
                event.preventDefault();
                if (this.connections.size === 0) return;
                
                if (event.dataTransfer.types.includes('Files')) {
                    this.elements.dragOverlay.classList.add('active');
                }
            }

            handleDragLeave(event) {
                event.preventDefault();
                if (event.clientX === 0 && event.clientY === 0) {
                    this.elements.dragOverlay.classList.remove('active');
                }
            }

            handleDrop(event) {
                event.preventDefault();
                this.elements.dragOverlay.classList.remove('active');
                
                if (this.connections.size === 0) {
                    this.showNotification('Connect to a room first!');
                    return;
                }

                const files = Array.from(event.dataTransfer.files);
                if (files.length > 0) {
                    this.processFiles(files);
                }
            }

            async processFiles(files) {
                for (const file of files) {
                    await this.sendFile(file);
                }
            }

            async sendFile(file) {
                const maxSize = 10 * 1024 * 1024; // 10MB
                if (file.size > maxSize) {
                    this.showNotification(`File "${file.name}" is too large. Max size: 10MB`);
                    return;
                }

                this.showUploadProgress(true, `Uploading ${file.name}...`);

                try {
                    const fileData = await this.fileToBase64(file);
                    
                    const message = {
                        type: 'file',
                        username: this.username,
                        fileData: {
                            name: file.name,
                            size: file.size,
                            type: file.type,
                            data: fileData,
                            timestamp: Date.now()
                        }
                    };

                    this.connections.forEach(conn => {
                        if (conn.open) {
                            conn.send(message);
                        }
                    });

                    this.addFileMessage(this.username, message.fileData);
                    this.showUploadProgress(false);
                    this.showNotification(`File "${file.name}" sent!`);

                } catch (error) {
                    console.error('Error sending file:', error);
                    this.showUploadProgress(false);
                    this.showNotification('Error uploading file');
                }
            }

            fileToBase64(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            }

            addFileMessage(author, fileData, saveToHistory = true) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message';
                
                const time = new Date(fileData.timestamp || Date.now()).toLocaleTimeString([], { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                let fileContent = '';
                
                if (this.isImageFile(fileData.type)) {
                    fileContent = `
                        <img src="${fileData.data}" 
                             class="file-preview" 
                             alt="${fileData.name}"
                             onclick="window.open('${fileData.data}', '_blank')"
                             title="Click to open in new tab">
                    `;
                } else {
                    const fileIcon = this.getFileIcon(fileData.type);
                    const fileSize = this.formatFileSize(fileData.size);
                    
                    fileContent = `
                        <div class="file-attachment" onclick="window.friendChat.downloadFile('${fileData.data}', '${fileData.name}')">
                            <div class="file-icon">${fileIcon}</div>
                            <div class="file-info">
                                <div class="file-name">${fileData.name}</div>
                                <div class="file-size">${fileSize}</div>
                            </div>
                        </div>
                    `;
                }

                messageDiv.innerHTML = `
                    <div class="message-header">
                        <span class="message-author">${author}</span>
                        <span class="message-time">${time}</span>
                    </div>
                    <div class="message-content">${fileContent}</div>
                `;

                this.elements.messagesContainer.appendChild(messageDiv);
                this.elements.messagesContainer.scrollTop = this.elements.messagesContainer.scrollHeight;

                if (saveToHistory) {
                    this.messages.push({
                        type: 'file',
                        author: author,
                        fileData: fileData,
                        timestamp: Date.now()
                    });
                    
                    if (this.messages.length > 50) {
                        this.messages = this.messages.slice(-50);
                    }
                }
            }

            isImageFile(mimeType) {
                return mimeType && mimeType.startsWith('image/');
            }

            getFileIcon(mimeType) {
                if (mimeType.startsWith('image/')) return 'üñºÔ∏è';
                if (mimeType.startsWith('video/')) return 'üé•';
                if (mimeType.startsWith('audio/')) return 'üéµ';
                if (mimeType.includes('pdf')) return 'üìÑ';
                if (mimeType.includes('word') || mimeType.includes('document')) return 'üìù';
                if (mimeType.includes('excel') || mimeType.includes('sheet')) return 'üìä';
                if (mimeType.includes('zip') || mimeType.includes('rar')) return 'üì¶';
                return 'üìÅ';
            }

            formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            downloadFile(dataUrl, filename) {
                const link = document.createElement('a');
                link.href = dataUrl;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            showUploadProgress(show, text = '') {
                if (show) {
                    this.elements.uploadProgress.classList.add('active');
                    this.elements.uploadText.textContent = text;
                } else {
                    this.elements.uploadProgress.classList.remove('active');
                }
            }

            autoResizeTextarea() {
                const textarea = this.elements.messageInput;
                textarea.style.height = 'auto';
                textarea.style.height = Math.min(textarea.scrollHeight, 100) + 'px';
            }

            showNotification(message) {
                const notification = document.createElement('div');
                notification.className = 'notification';
                notification.textContent = message;
                document.body.appendChild(notification);

                setTimeout(() => {
                    notification.remove();
                }, 3000);
            }
        }

        // Initialize the app
        window.friendChat = new FriendChatPro();
    </script>
</body>
</html>
